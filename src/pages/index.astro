---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';

// Move high-computation logic to build time
const models = import.meta.glob('/src/content/docs/docs/models/generated/*.md', { eager: true });

// Process and sort models
const topModels = Object.values(models)
  .map((model: any) => {
    // Extract metadata from markdown content (basic regex as frontmatter is plain)
    // Actually, models are loaded as modules with `frontmatter` export if using eager? No, markdown imports give us `.frontmatter`.
    // Let's rely on the file content if the module import works, which it should in Astro.
    const fm = model.frontmatter || {};
    // Fallback parsing if needed, but import.meta.glob with md usually works.
    // The previous view_file showed the content.
    // Let's scrape the "Likes" and "Downloads" from the body text since they are in a table at the bottom?
    // The viewed file has: | **Likes** | 861 |
    const content = model.rawContent ? model.rawContent() : (model.default || '');
    
    // Regex to extract stats from the specific table format we saw
    const likesMatch = content.match(/\|\s*\*\*Likes\*\*\s*\|\s*([\d,]+[kKM]?)\s*\|/);
    const downloadsMatch = content.match(/\|\s*\*\*Downloads\*\*\s*\|\s*([\d,]+[kKM]?)\s*\|/);
    const idMatch = content.match(/\|\s*\*\*Model ID\*\*\s*\|\s*`([^`]+)`\s*\|/);
    
    // Helper to parse "3.9M", "861", etc to numbers
    const parseMetric = (str) => {
      if (!str) return 0;
      str = str.replace(/,/g, '');
      if (str.toUpperCase().endsWith('K')) return parseFloat(str) * 1000;
      if (str.toUpperCase().endsWith('M')) return parseFloat(str) * 1000000;
      return parseFloat(str);
    };

    const likesRaw = likesMatch ? likesMatch[1] : '0';
    const downloadsRaw = downloadsMatch ? downloadsMatch[1] : '0';
    
    return {
      id: idMatch ? idMatch[1] : fm.title || 'Unknown',
      url: model.url || `/slmhub/docs/models/generated/${model.file.split('/').pop().replace('.md', '/')}`,
      likes: parseMetric(likesRaw),
      likesDisplay: likesRaw,
      downloads: parseMetric(downloadsRaw),
      downloadsDisplay: downloadsRaw,
      description: fm.description || 'No description available.'
    };
  })
  .sort((a, b) => b.likes - a.likes)
  .slice(0, 5);

const frontmatter = {
  title: 'SLM Hub',
  description: 'Developer-centric documentation for Small Language Models (SLMs). Learn, choose, and deploy locally or at the edge.',
  template: 'splash',
  prev: false,
  next: false,
};
---

<StarlightPage frontmatter={frontmatter} headings={[]}>
  <div class="sl-container">
    <div class="hero">
      <div class="hero-content">
        <h1 class="hero-title">
          Small Models. <span class="gradient-text">Big Impact.</span>
        </h1>
        <p class="hero-tagline">
          Developer-centric documentation for Small Language Models (SLMs). All guides are executable Jupyter Notebooks you can run in Google Colab.
        </p>
        <div class="hero-actions">
          <a href="/slmhub/docs/start-here/" class="sl-link-button" data-variant="primary">
            <span>Start Course ‚Üí</span>
          </a>
          <a href="/slmhub/docs/models/generated/directory/" class="sl-link-button" data-variant="minimal">
            <span>Browse Models</span>
          </a>
        </div>
      </div>
      <div class="hero-image">
        <img src="/slmhub/logo.svg" alt="SLM Hub" class="floating-logo"/>
      </div>
    </div>

    <!-- Master 2026 Grid -->
    <div class="section-container">
      <h2 class="section-title">Master SLMs in 2026</h2>
      <p class="section-subtitle">A complete path from theory to production deployment on the edge.</p>
      
      <div class="bento-grid">
        <a href="/slmhub/docs/start-here/" class="bento-card course-card">
          <div class="card-icon">üéì</div>
          <h3>Course</h3>
          <p>Interactive notebooks starting from zero. Learn by doing with free Colab GPU runtimes.</p>
        </a>
        <a href="/slmhub/docs/learn/fundamentals/" class="bento-card foundations-card">
          <div class="card-icon">üß†</div>
          <h3>Foundations</h3>
          <p>Tokenization, Quantization (GGUF/AWQ), and Architecture explained simply.</p>
        </a>
        <a href="/slmhub/docs/models/generated/directory/" class="bento-card models-card">
           <div class="card-icon">üì¶</div>
           <h3>Models</h3>
           <p>Auto-updated directory of the best sub-10B parameter models available today.</p>
        </a>
        <a href="/slmhub/docs/deploy/" class="bento-card deploy-card">
           <div class="card-icon">üöÄ</div>
           <h3>Deploy</h3>
           <p>Production patterns for Ollama, vLLM, and Llama.cpp edge deployment.</p>
        </a>
      </div>
    </div>

    <!-- Foundations Spotlight -->
    <div class="foundations-section full-bleed">
       <div class="foundations-content">
          <h2>Why Foundations Matter?</h2>
          <p>
            You can't optimize what you don't understand. To run efficient SLMs on limited hardware, 
            you need to master <strong>Quantization</strong>, <strong>Context Windows</strong>, and <strong>Inference Engines</strong>.
          </p>
          <a href="/slmhub/docs/learn/fundamentals/" class="white-button">Get Strong Foundations</a>
       </div>
    </div>

    <!-- Top Models Table -->
    <div class="section-container">
      <div class="split-header">
        <div>
          <h2 class="section-title">Trending Models</h2>
          <p class="section-subtitle">Top rated SLMs sorted by Hugging Face stars.</p>
        </div>
        <a href="/slmhub/docs/models/generated/directory/" class="view-all-link">View Directory ‚Üí</a>
      </div>

      <div class="table-container glass-card">
        <table>
          <thead>
            <tr>
              <th>Model ID</th>
              <th>Description</th>
              <th class="text-right">Likes</th>
              <th class="text-right">Downloads</th>
            </tr>
          </thead>
          <tbody>
            {topModels.map(model => (
              <tr>
                <td>
                  <a href={model.url} class="model-id-link">{model.id}</a>
                </td>
                <td class="desc-cell">{model.description.slice(0, 60)}...</td>
                <td class="text-right stat-cell">‚≠ê {model.likesDisplay}</td>
                <td class="text-right stat-cell">‚¨áÔ∏è {model.downloadsDisplay}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Newsletter -->
    <div class="newsletter-section glass-card">
      <div class="newsletter-content">
         <h2>Stay Updated</h2>
         <p>Join 2,000+ engineers mastering the edge AI revolution.</p>
         <div class="email-form">
           <input type="email" placeholder="enter@email.com" />
           <button>Subscribe</button>
         </div>
      </div>
    </div>

  </div>
</StarlightPage>

<style>
  /* Hero */
  .hero {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: center;
    padding: 4rem 0;
    min-height: 50vh;
  }
  .hero-title {
    font-size: 3.5rem;
    font-weight: 700;
    line-height: 1.1;
    margin-bottom: 1.5rem;
    font-family: 'Space Grotesk', system-ui, sans-serif;
  }
  .hero-tagline {
    font-size: 1.2rem;
    margin-bottom: 2rem;
    color: var(--sl-color-gray-3);
    line-height: 1.6;
    max-width: 500px;
  }
  .floating-logo {
    width: 300px;
    height: auto;
    filter: drop-shadow(0 0 30px rgba(255,107,53, 0.2));
    animation: float 6s ease-in-out infinite;
  }

  /* Bento Grid */
  .section-container { margin: 6rem 0; }
  .section-title { font-size: 2.2rem; font-weight: 700; margin-bottom: 0.5rem; }
  .section-subtitle { color: var(--sl-color-gray-3); margin-bottom: 2rem; font-size: 1.1rem; }
  
  .bento-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
  }
  .bento-card {
    padding: 2rem;
    border-radius: 1rem;
    border: 1px solid var(--sl-color-gray-5);
    background: var(--sl-color-bg-nav);
    text-decoration: none;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .bento-card:hover {
    transform: translateY(-5px);
    border-color: var(--sl-color-accent);
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
  }
  .card-icon { font-size: 2rem; }
  .bento-card h3 { font-size: 1.4rem; font-weight: 700; color: var(--sl-color-white); }
  .bento-card p { color: var(--sl-color-gray-3); font-size: 0.95rem; line-height: 1.5; }

  /* Foundations Full Bleed */
  .full-bleed {
    width: 100vw;
    margin-left: calc(50% - 50vw);
    padding: 4rem 0;
    background: linear-gradient(135deg, var(--sl-color-accent-low), var(--sl-color-accent-high));
    display: flex;
    justify-content: center;
    color: white;
    box-shadow: inset 0 0 50px rgba(0,0,0,0.2);
  }
  .foundations-content {
    max-width: 800px;
    text-align: center;
    padding: 0 2rem;
  }
  .foundations-content h2 { font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; color: white; }
  .foundations-content p { font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9; }
  .white-button {
    background: white;
    color: var(--sl-color-accent);
    padding: 0.8rem 2rem;
    border-radius: 2rem;
    font-weight: 700;
    text-decoration: none;
    transition: transform 0.2s;
    display: inline-block;
  }
  .white-button:hover { transform: scale(1.05); }

  /* Table */
  .split-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; }
  .view-all-link { color: var(--sl-color-accent); text-decoration: none; font-weight: 600; }
  .table-container { overflow-x: auto; padding: 0.5rem; border-radius: 1rem; }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  th { text-align: left; padding: 1rem; color: var(--sl-color-gray-3); font-size: 0.9rem; border-bottom: 1px solid var(--sl-color-gray-5); }
  td { padding: 1rem; border-bottom: 1px solid var(--sl-color-gray-6); }
  .text-right { text-align: right; }
  .model-id-link { font-family: monospace; font-weight: 700; color: var(--sl-color-white); text-decoration: none; }
  .desc-cell { color: var(--sl-color-gray-4); font-size: 0.9rem; }
  .stat-cell { font-family: monospace; }

  /* Newsletter */
  .newsletter-section { padding: 4rem 2rem; text-align: center; border-radius: 1rem; margin: 4rem 0; }
  .email-form {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1.5rem;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
  input { background: rgba(0,0,0,0.2); border: 1px solid var(--sl-color-gray-5); padding: 0.8rem; border-radius: 0.5rem; color: white; flex: 1; }
  button { background: var(--sl-color-accent); border: none; padding: 0.8rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 700; cursor: pointer; }

  @media (max-width: 768px) {
    .hero { grid-template-columns: 1fr; text-align: center; }
    .hero-actions { justify-content: center; }
    .floating-logo { display: none; }
    .split-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
  }
</style>
